<!-- Importăm fișierul de stiluri dedicat -->
<link rel="stylesheet" href="/css/lesson.css">

<!-- Importăm Fonturi de Lectură Premium -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@300;400;700;900&family=Roboto+Slab:wght@300;400;700&family=Inconsolata:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

<!-- MathJax & JSXGraph -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />
<script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>

<%
    const currentLangCode = (typeof activeLang !== 'undefined' && activeLang.name) ? activeLang.name.toLowerCase() : 'ro';
    
    let displayData = {
        title: lesson.title,
        subtitle: lesson.subtitle,
        sections: [] 
    };

    if (lesson.content && typeof lesson.content === 'object' && !Array.isArray(lesson.content)) {
        if (lesson.content[currentLangCode] && lesson.content[currentLangCode].title) {
            displayData = lesson.content[currentLangCode];
        } else if (lesson.content['ro'] && lesson.content['ro'].title) {
            displayData = lesson.content['ro'];
        } 
    } 
    else if (Array.isArray(lesson.content)) {
        displayData.sections = lesson.content;
    }

    const categorySlugs = {
        'Matematică': 'math', 'Științe': 'science', 'Istorie': 'history', 
        'Geografie': 'geography', 'Italiana': 'italian', 'English': 'english', 'IT': 'it'
    };
    const catSlug = categorySlugs[lesson.category] || lesson.category.toLowerCase();

    const categoryNames = {
        'Matematică': __('subjects.math'),
        'Științe': __('subjects.science'),
        'Istorie': __('subjects.history'),
        'Geografie': __('subjects.geography'),
        'Italiana': __('subjects.italian'),
        'English': __('subjects.english'),
        'IT': __('subjects.it'),
        'Limbi': __('subjects.languages')
    };
    const displayCategory = categoryNames[lesson.category] || lesson.category;
%>

<!-- Breadcrumbs -->
<nav aria-label="Breadcrumb" id="breadcrumbs" class="max-w-[1400px] mx-auto px-4 pt-24 pb-2 flex items-center gap-2 text-xs sm:text-sm opacity-70 transition-opacity hover:opacity-100 overflow-hidden whitespace-nowrap" style="color: var(--l-text-secondary);">
    <a href="/" aria-label="Acasa" class="hover:text-[var(--l-accent)] transition shrink-0"><i class='bx bx-home'></i></a>
    <span aria-hidden="true">/</span>
    <a href="/#materii" class="hover:text-[var(--l-accent)] transition shrink-0"><%= __('lesson.breadcrumbs.subjects') %></a>
    <span aria-hidden="true">/</span>
    <a href="/materii/<%= catSlug %>" class="hover:text-[var(--l-accent)] transition font-medium shrink-0">
        <%= displayCategory %>
    </a>
    <span aria-hidden="true">/</span>
    <span style="color: var(--l-accent); font-weight: bold;" class="truncate" aria-current="page"><%= displayData.title %></span>
</nav>

<!-- Container Principal al Lecției -->
<div class="lesson-wrapper" data-lesson-id="<%= lesson.id %>" data-user-logged="<%= !!(typeof user !== 'undefined' && user) %>">
    <!-- CARTEA 3D -->
    <div class="book-frame">
        
        <!-- Cotorul Central -->
        <div class="book-spine"></div>
        
        <!-- === SIDEBAR (Stanga) === -->
        <aside class="book-panel panel-left hidden md:flex">
            <div class="sidebar-content custom-scroll">
                
                <!-- Header -->
                <div class="lesson-header mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="badge-category">
                            INFO.01
                        </span>
                        <span style="color: var(--l-text-secondary); font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                            <i class='bx bx-category'></i> <%= displayCategory %>
                        </span>
                    </div>
                    <h1 class="text-xl sm:text-2xl md:text-3xl font-extrabold leading-tight font-serif" style="color: var(--l-text-primary);">
                        <%= displayData.title %>
                    </h1>

                    <!-- INFO AUTOR -->
                    <div class="flex items-center gap-3 mt-4 pt-4 border-t border-white/10">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold shadow-md">
                            <%= lesson.profiles && lesson.profiles.full_name ? lesson.profiles.full_name.charAt(0).toUpperCase() : 'A' %>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-400">Creat de</span>
                            <span class="text-sm font-bold text-white flex items-center gap-2">
                                <%= lesson.profiles ? lesson.profiles.full_name : 'Autor Necunoscut' %>
                                <% if (lesson.profiles && lesson.profiles.role !== 'admin') { %>
                                    <span class="px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400 text-[10px] font-bold uppercase border border-amber-500/30 flex items-center gap-1">
                                        <i class='bx bxs-badge-check'></i> Contribuitor
                                    </span>
                                <% } %>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tab Switcher -->
                <div class="tab-switcher">
                    <button onclick="switchTab('toc')" id="btn-tab-toc" class="tab-btn active">Cuprins</button>
                    <button onclick="switchTab('chat')" id="btn-tab-chat" class="tab-btn">Întrebări</button>
                </div>

                <!-- TAB: Cuprins -->
                <div id="content-toc" class="space-y-1 transition-opacity duration-300">
                    <% if (displayData.sections) { %>
                        <% displayData.sections.forEach((section, index) => { %>
                            <a href="#sec-<%= index %>" class="block px-3 py-2 rounded-lg transition-colors duration-200 hover:bg-[var(--l-bg-surface-hover)]" style="color: var(--l-text-secondary);" data-target="sec-<%= index %>">
                                <div class="flex items-start gap-3">
                                    <span style="font-family: monospace; opacity: 0.5; padding-top: 2px;"><%= (index + 1).toString().padStart(2, '0') %></span>
                                    <span style="font-weight: 500; font-size: 0.9em;"><%= section.title %></span>
                                </div>
                            </a>
                        <% }) %>
                    <% } %>
                    
                    <div class="mt-8 p-4 rounded-xl border border-dashed text-center cursor-pointer transition hover:scale-[1.02]" style="border-color: var(--l-border); background: var(--l-bg-surface-hover);" onclick="window.open('https://buymeacoffee.com/sapperepluk', '_blank')">
                        <i class='bx bxs-coffee-togo text-2xl mb-1' style="color: var(--l-text-secondary);"></i>
                        <p style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--l-text-secondary);">Susține Proiectul</p>
                    </div>
                </div>

                <!-- TAB: Chat -->
                <div id="content-chat" class="hidden space-y-4">
                    <div class="p-3 rounded-r-lg border-l-4" style="background: var(--l-accent-glow); border-color: var(--l-accent);">
                        <p style="font-size: 0.8rem; color: var(--l-text-primary);">
                            <span style="font-weight: 800; color: var(--l-accent);">SapereBot:</span> Ai nelămuriri? Comunitatea te poate ajuta aici.
                        </p>
                    </div>
                    <div id="chat-input-area" class="relative mt-4">
                        <input type="text" placeholder="Adaugă o întrebare...">
                        <button><i class='bx bxs-send'></i></button>
                    </div>
                </div>

            </div>
        </aside>

        <!-- === PAGE RIGHT (Conținut) === -->
        <article class="book-panel panel-right pb-32">
            <span class="absolute top-4 right-4 text-[10px] font-mono opacity-50 page-corner" style="color: var(--l-text-secondary);">PG. 1</span>
            
            <div class="lesson-content custom-scroll" id="lesson-article" style="font-size: 18px; line-height: 1.6;">
                <% if (displayData.sections && displayData.sections.length > 0) { %>
                    <% displayData.sections.forEach((section, index) => { %>
                        <section id="sec-<%= index %>" class="mb-16">
                            <div class="flex items-end gap-3 mb-6 pb-2 border-b" style="border-color: var(--l-border);">
                                <span style="font-size: 2.5em; font-family: serif; font-weight: 700; color: var(--l-accent); opacity: 0.3; line-height: 0.8;"><%= index + 1 %></span>
                                <h2 style="margin: 0; border: none; padding: 0;" class="font-serif"><%= section.title %></h2>
                            </div>

                            <div style="color: var(--l-text-secondary);">
                                <% if (section.blocks && Array.isArray(section.blocks)) { %>
                                    <% section.blocks.forEach((block, bIndex) => { %>
                                        
                                        <% if (block.type === 'paragraph') { %>
                                            <div class="ql-editor !p-0 !h-auto text-lg mb-6" style="font-size: 1em !important; color: var(--l-text-secondary);">
                                                <%- block.content %>
                                            </div>
                                        <% } %>

                                        <% if (block.type === 'title') { %>
                                            <h3 class="text-xl sm:text-2xl font-bold mt-8 mb-4 font-serif" style="color: var(--l-text-primary);">
                                                <%= block.content %>
                                            </h3>
                                        <% } %>

                                        <% if (block.type === 'list') { %>
                                            <ul class="list-disc pl-6 space-y-2 mb-6" style="color: var(--l-text-secondary);">
                                                <% if (block.items && Array.isArray(block.items)) { %>
                                                    <% block.items.forEach(item => { %>
                                                        <li class="pl-2"><%= item %></li>
                                                    <% }) %>
                                                <% } %>
                                            </ul>
                                        <% } %>

                                        <% if (block.type === 'definition') { %>
                                            <div class="block-definition mb-6 p-4 rounded-xl border-l-4 border-cyan-500 bg-[var(--l-bg-surface-hover)]">
                                                <h4 class="font-bold mb-1 text-cyan-600 dark:text-cyan-400 flex items-center gap-2">
                                                    <i class='bx bx-book-open'></i> <%= block.term %>
                                                </h4>
                                                <p style="color: var(--l-text-secondary); font-style: italic;"><%= block.description %></p>
                                            </div>
                                        <% } %>

                                        <% if (block.type === 'formula') { %>
                                            <div class="my-6 p-6 rounded-xl text-center border transition hover:border-[var(--l-accent)]" 
                                                 style="background: var(--l-bg-surface-hover); border-color: var(--l-border);">
                                                <div class="text-xl overflow-x-auto py-2" style="color: var(--l-text-primary);">
                                                    $$<%= block.content %>$$
                                                </div>
                                                <% if (block.explanation) { %>
                                                    <p class="text-sm mt-3 opacity-70" style="color: var(--l-text-secondary);">
                                                        <i class='bx bx-info-circle'></i> <%= block.explanation %>
                                                    </p>
                                                <% } %>
                                            </div>
                                        <% } %>

                                        <% if (block.type === 'table') { %>
                                            <% 
                                                let safeTableData = block.content;
                                                if (typeof safeTableData !== 'string') {
                                                    safeTableData = JSON.stringify(safeTableData);
                                                }
                                            %>
                                            <div class="my-8 w-full overflow-x-auto rounded-xl border border-slate-700 shadow-md">
                                                <div class="js-dynamic-table min-w-[300px]" data-table-content="<%= safeTableData %>">
                                                    <div class="p-4 text-center text-xs opacity-50">Se încarcă tabelul...</div>
                                                </div>
                                            </div>
                                        <% } %>

                                        <% if (block.type === 'geometry') { %>
                                            <div class="my-8 relative z-10">
                                                <div id="geo-view-<%= index %>-<%= bIndex %>" class="w-full aspect-square md:aspect-video rounded-xl border shadow-lg bg-white" style="border-color: var(--l-border);"></div>
                                                <script type="text/template" id="geo-code-<%= index %>-<%= bIndex %>"><%- block.code %></script>
                                                <script>
                                                    (function() {
                                                        const boardId = 'geo-view-<%= index %>-<%= bIndex %>';
                                                        const codeId = 'geo-code-<%= index %>-<%= bIndex %>';
                                                        window.addEventListener('load', function() {
                                                            if (typeof JXG !== 'undefined') {
                                                                try {
                                                                    const board = JXG.JSXGraph.initBoard(boardId, { boundingbox: [-5, 5, 5, -5], axis: true, showCopyright: false, pan: { enabled: true }, zoom: { enabled: true } });
                                                                    const code = document.getElementById(codeId).textContent;
                                                                    new Function('board', code)(board);
                                                                } catch(e) { console.error(e); }
                                                            }
                                                        });
                                                    })();
                                                </script>
                                            </div>
                                        <% } %>

                                        <% if (block.type === 'resource') { %>
                                            <% 
                                                const url = block.url || '';
                                                const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');
                                                const isImage = url.match(/\.(jpeg|jpg|gif|png|webp|bmp|svg)/i) != null || (url.includes('firebasestorage') && url.includes('alt=media'));
                                            %>

                                            <div class="my-6 w-full">
                                                <% if (isYouTube) { %>
                                                    <div class="aspect-video rounded-xl overflow-hidden border shadow-lg" style="border-color: var(--l-border);">
                                                        <iframe width="100%" height="100%" src="<%= url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/') %>" frameborder="0" allowfullscreen></iframe>
                                                    </div>
                                                <% } else if (isImage) { %>
                                                    <div class="rounded-xl overflow-hidden border shadow-lg" style="border-color: var(--l-border);">
                                                        <img src="<%= url %>" alt="<%= block.title || 'Imagine' %>" class="w-full h-auto object-cover" loading="lazy">
                                                    </div>
                                                <% } else { %>
                                                    <a href="<%= url %>" target="_blank" class="flex flex-col sm:flex-row items-center gap-4 p-4 rounded-xl border transition group hover:scale-[1.01]" style="background: var(--l-bg-surface-hover); border-color: var(--l-border);">
                                                        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl shrink-0" style="background: var(--l-accent-glow); color: var(--l-accent);">
                                                            <i class='bx <%= block.resourceType === 'pdf' ? 'bxs-file-pdf' : 'bx-link' %>'></i>
                                                        </div>
                                                        <div class="flex-1 min-w-0 text-center sm:text-left">
                                                            <h4 class="font-bold text-sm mb-1 group-hover:text-[var(--l-accent)] transition truncate w-full" style="color: var(--l-text-primary);">
                                                                <%= block.title || 'Resursă Externă' %>
                                                            </h4>
                                                            <p class="text-xs truncate opacity-70" style="color: var(--l-text-secondary);"><%= url %></p>
                                                        </div>
                                                    </a>
                                                <% } %>
                                            </div>
                                        <% } %>

                                    <% }) %>
                                <% } %>
                            </div>
                        </section>
                    <% }) %>
                <% } %>
                
                <div class="mt-12 pt-8 border-t border-dashed text-center" style="border-color: var(--l-border);">
                    <i class='bx bx-check-circle text-4xl mb-2 opacity-50' style="color: var(--l-text-secondary);"></i>
                    <p style="font-size: 0.85em; color: var(--l-text-secondary);">Ai ajuns la finalul lecției.</p>
                </div>
            </div>
        </article>

    </div>
</div>

<!-- ============================================================== -->
<!-- ELEMENTE FIXED: MENIU SETĂRI ȘI FOOTER (SCOASE DIN WRAPPER) -->
<!-- ============================================================== -->

<!-- 1. SETTINGS PANEL (Drop-up Menu) -->
<div id="reading-settings-menu" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[10001] w-[95%] max-w-sm bg-[#1e293b]/95 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl p-6 hidden pointer-events-auto">
    <div class="flex justify-between items-center mb-6 pb-2 border-b border-white/10">
        <span class="text-xs font-extrabold uppercase tracking-widest text-gray-400">Preferințe Lectură</span>
        <button onclick="toggleSettingsMenu()" class="text-gray-400 hover:text-white p-1 hover:bg-white/10 rounded-full transition cursor-pointer"><i class='bx bx-x text-xl'></i></button>
    </div>

    <!-- TEMA -->
    <div class="mb-6">
        <label class="block text-[10px] text-gray-500 uppercase font-bold mb-3 flex items-center gap-2"><i class='bx bx-palette'></i> Temă</label>
        <div class="grid grid-cols-2 gap-3 bg-black/20 p-1.5 rounded-2xl">
            <button onclick="setTheme('dark')" class="theme-option flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-bold transition hover:bg-white/5 active-theme cursor-pointer" id="btn-theme-dark">
                <i class='bx bxs-moon text-lg'></i> Întunecat
            </button>
            <button onclick="setTheme('light')" class="theme-option flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-bold transition hover:bg-white/5 text-gray-400 cursor-pointer" id="btn-theme-light">
                <i class='bx bxs-sun text-lg'></i> Luminos
            </button>
        </div>
    </div>

    <!-- FONT FAMILY -->
    <div class="mb-6">
        <label class="block text-[10px] text-gray-500 uppercase font-bold mb-3 flex items-center gap-2"><i class='bx bx-font'></i> Font</label>
        <div class="grid grid-cols-5 gap-2">
            <button onclick="setFont('Inter')" class="font-btn p-2 rounded-xl border border-transparent hover:bg-white/10 text-center transition group active-font cursor-pointer" title="Inter (Modern)">
                <span class="block text-xl font-[Inter] mb-1 group-hover:text-sapereOrange transition">Aa</span>
                <span class="text-[9px] opacity-60 font-bold uppercase">Sans</span>
            </button>
            <button onclick="setFont('Merriweather')" class="font-btn p-2 rounded-xl border border-transparent hover:bg-white/10 text-center transition group cursor-pointer" title="Merriweather (Clasic)">
                <span class="block text-xl font-[Merriweather] mb-1 group-hover:text-sapereOrange transition">Aa</span>
                <span class="text-[9px] opacity-60 font-bold uppercase">Serif</span>
            </button>
            <button onclick="setFont('Roboto Slab')" class="font-btn p-2 rounded-xl border border-transparent hover:bg-white/10 text-center transition group cursor-pointer" title="Roboto Slab (Robust)">
                <span class="block text-xl font-['Roboto_Slab'] mb-1 group-hover:text-sapereOrange transition">Aa</span>
                <span class="text-[9px] opacity-60 font-bold uppercase">Slab</span>
            </button>
            <button onclick="setFont('Inconsolata')" class="font-btn p-2 rounded-xl border border-transparent hover:bg-white/10 text-center transition group cursor-pointer" title="Inconsolata (Tech)">
                <span class="block text-xl font-['Inconsolata'] mb-1 group-hover:text-sapereOrange transition">Aa</span>
                <span class="text-[9px] opacity-60 font-bold uppercase">Mono</span>
            </button>
            <button onclick="setFont('Nunito')" class="font-btn p-2 rounded-xl border border-transparent hover:bg-white/10 text-center transition group cursor-pointer" title="Nunito (Friendly)">
                <span class="block text-xl font-['Nunito'] mb-1 group-hover:text-sapereOrange transition">Aa</span>
                <span class="text-[9px] opacity-60 font-bold uppercase">Soft</span>
            </button>
        </div>
    </div>

    <!-- SIZE & SPACING -->
    <div class="space-y-4">
        <div>
            <div class="flex justify-between mb-2">
                <label class="text-[10px] text-gray-500 uppercase font-bold">Mărime</label>
                <span id="font-size-display" class="text-[10px] text-sapereOrange font-mono">18px</span>
            </div>
            <div class="flex items-center gap-3 bg-black/20 rounded-xl p-2">
                <button onclick="changeFont(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded-lg text-sm bg-white/5 active:bg-white/10 cursor-pointer"><i class='bx bx-minus'></i></button>
                <input type="range" min="14" max="32" value="18" step="1" id="font-size-slider" class="flex-1 accent-sapereOrange h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="setFontSize(this.value)">
                <button onclick="changeFont(1)" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded-lg text-sm bg-white/5 active:bg-white/10 cursor-pointer"><i class='bx bx-plus'></i></button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <!-- Line Height -->
            <div>
                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-2">Spațiere</label>
                <div class="flex bg-black/20 rounded-xl p-1">
                    <button onclick="setLineHeight(1.4)" class="flex-1 py-1.5 text-[10px] hover:bg-white/10 rounded-lg transition lh-btn cursor-pointer" title="Compact"><i class='bx bx-menu'></i></button>
                    <button onclick="setLineHeight(1.6)" class="flex-1 py-1.5 text-[10px] hover:bg-white/10 rounded-lg transition lh-btn font-bold active-lh cursor-pointer" title="Normal"><i class='bx bx-menu-alt-left'></i></button>
                    <button onclick="setLineHeight(2.0)" class="flex-1 py-1.5 text-[10px] hover:bg-white/10 rounded-lg transition lh-btn cursor-pointer" title="Relaxat"><i class='bx bx-menu-alt-right'></i></button>
                </div>
            </div>
            <!-- Alignment -->
            <div>
                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-2">Aliniere</label>
                <div class="flex bg-black/20 rounded-xl p-1">
                    <button onclick="setTextAlign('left')" class="flex-1 py-1.5 text-xs hover:bg-white/10 rounded-lg transition align-btn active-align cursor-pointer"><i class='bx bx-align-left'></i></button>
                    <button onclick="setTextAlign('justify')" class="flex-1 py-1.5 text-xs hover:bg-white/10 rounded-lg transition align-btn cursor-pointer"><i class='bx bx-align-justify'></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- EXTRAS -->
    <div class="pt-5 mt-5 border-t border-white/10 flex justify-between items-center">
        <button onclick="toggleZen()" class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-sapereOrange transition group cursor-pointer">
            <span class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-sapereOrange/20"><i class='bx bx-expand'></i></span>
            Zen Mode
        </button>
        <button onclick="toggleModal('modal-notes')" class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-sapereOrange transition group cursor-pointer">
            <span class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-sapereOrange/20"><i class='bx bx-edit-alt'></i></span>
            Notițe
        </button>
    </div>
</div>

<!-- 2. STICKY ACTION BAR (Main Footer) -->
<div id="sticky-action-bar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-[9999] flex items-center gap-2 px-3 py-2 bg-[#1e293b]/90 backdrop-blur-xl border border-white/10 rounded-full shadow-2xl transition-all duration-300 translate-y-24 opacity-0 pointer-events-auto max-w-[95vw]">
    
    <!-- Settings Trigger -->
    <button onclick="toggleSettingsMenu()" id="btn-settings-trigger" class="w-11 h-11 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition flex-shrink-0 relative group cursor-pointer" title="Setări Lectură">
        <i class='bx bx-font text-xl'></i>
        <span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-sapereOrange rounded-full border-2 border-[#1e293b] hidden group-hover:block animate-ping"></span>
    </button>

    <div class="w-px h-6 bg-white/10 flex-shrink-0 mx-1"></div>

    <!-- Navigation/Action Buttons -->
    <% if (typeof user !== 'undefined' && user) { %>
        <% if (typeof isCompleted !== 'undefined' && isCompleted) { %>
            <button type="button" onclick="resetLesson()" id="bar-btn-reset" class="flex items-center gap-2 px-5 py-2.5 rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 hover:text-white transition font-bold text-sm border border-gray-600 hover:border-gray-500 shadow-sm whitespace-nowrap active:scale-95 cursor-pointer">
                <i class='bx bx-refresh text-lg'></i> <span class="hidden sm:inline">Resetează</span>
            </button>
            <div class="flex items-center gap-2 px-5 py-2.5 rounded-full bg-green-500/10 text-green-400 font-bold text-sm border border-green-500/20 cursor-default whitespace-nowrap">
                <i class='bx bx-check-circle text-lg'></i> <span class="hidden sm:inline">Finalizată</span>
            </div>
        <% } else { %>
            <button type="button" onclick="completeLesson()" id="bar-btn-complete" class="flex items-center gap-2 px-6 py-2.5 rounded-full bg-gradient-to-r from-sapereOrange to-orange-600 text-white hover:shadow-lg hover:shadow-orange-500/30 hover:scale-105 transition font-bold text-sm shadow-md border border-orange-500/50 whitespace-nowrap active:scale-95 cursor-pointer">
                <i class='bx bx-check-double text-xl'></i> <span>Completează</span>
            </button>
        <% } %>
    <% } else { %>
        <a href="/auth/login" class="flex items-center gap-2 px-5 py-2.5 rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 hover:text-white transition font-bold text-sm border border-gray-600 whitespace-nowrap active:scale-95 cursor-pointer">
            <i class='bx bx-log-in-circle text-lg'></i> <span>Autentifică-te</span>
        </a>
    <% } %>

    <div class="w-px h-6 bg-white/10 flex-shrink-0 hidden sm:block mx-1"></div>

    <!-- TTS Trigger -->
    <button onclick="toggleTTS()" class="hidden sm:flex w-11 h-11 rounded-full items-center justify-center text-gray-400 hover:text-sapereOrange hover:bg-white/10 transition flex-shrink-0 cursor-pointer" title="Ascultă Lecția">
        <i class='bx bx-play text-2xl ml-0.5'></i>
    </button>
</div>

<!-- Floating Selection Button (Highlight/Flashcard) -->
<button id="selection-trigger-btn" class="hidden fixed z-[9999] bg-[#f59e0b] text-white p-2 rounded-lg shadow-xl hover:scale-110 transition transform animate-bounce-in cursor-pointer" onclick="openFlashcardPopover()" style="pointer-events: auto;">
    <i class='bx bx-layer-plus text-xl'></i>
</button>

<!-- Modalul de creare Flashcard -->
<div id="flashcard-popover" class="hidden fixed z-[9999] bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl p-4 w-80 animate-fade-in backdrop-blur-md bg-opacity-95">
    <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
            <i class='bx bx-card text-[#f59e0b]'></i> Flashcard Nou
        </h3>
        <button onclick="closeFlashcardPopover()" class="text-gray-500 hover:text-white transition cursor-pointer"><i class='bx bx-x text-lg'></i></button>
    </div>
    
    <div class="space-y-3">
        <!-- Față -->
        <div>
            <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Față (Text Selectat)</label>
            <div id="fc-front-preview" class="text-sm text-white font-medium bg-black/30 p-2.5 rounded-lg border border-gray-700 max-h-24 overflow-y-auto"></div>
        </div>
        <!-- Spate -->
        <div>
            <div class="flex justify-between items-center mb-1">
                <label class="block text-[10px] text-gray-500 uppercase font-bold">Spate (Traducere/Definiție)</label>
                <!-- AI Toggle -->
                <button onclick="aiTranslateSelection()" id="btn-ai-translate" class="text-[10px] bg-indigo-500/10 text-indigo-400 hover:bg-indigo-500 hover:text-white px-2 py-0.5 rounded transition flex items-center gap-1 border border-indigo-500/30 cursor-pointer">
                    <i class='bx bxs-magic-wand'></i> AI Translate
                </button>
            </div>
            <div class="relative">
                <textarea id="fc-back-input" rows="3" class="w-full bg-black/30 border border-gray-700 rounded-lg p-2.5 text-sm text-white focus:border-[#f59e0b] outline-none placeholder-gray-600 transition resize-none" placeholder="Scrie definiția sau lasă AI-ul..."></textarea>
                <div id="ai-loading" class="absolute inset-0 bg-black/50 rounded-lg flex items-center justify-center hidden backdrop-blur-sm">
                    <i class='bx bx-loader-alt bx-spin text-indigo-400 text-2xl'></i>
                </div>
            </div>
        </div>
        <!-- Save -->
        <button onclick="saveFlashcardFromPopover()" id="btn-save-fc" class="w-full py-2.5 bg-[#f59e0b] hover:bg-orange-600 text-white font-bold rounded-lg text-xs shadow-lg transition flex items-center justify-center gap-2 cursor-pointer">
            <i class='bx bx-save'></i> Salvează în Colecție
        </button>
    </div>
</div>

<%- include('../partials/modals') %>

<!-- STYLE INJECTION PENTRU TEME REFACTORIZATE -->
<style>
    /* CSS Variables for Robust Themes */
    :root {
        /* Default Dark Mode (High Contrast Slate) */
        --l-bg-body: #0f172a;
        --l-bg-book: #1e293b;
        --l-bg-sidebar: #0f172a;
        --l-bg-surface: #1e293b;
        --l-bg-surface-hover: #334155;
        --l-text-primary: #e2e8f0; /* Slate-200 - Very Readable */
        --l-text-secondary: #94a3b8; /* Slate-400 */
        --l-border: rgba(255, 255, 255, 0.1);
        --l-accent: #f59e0b;
        --l-accent-glow: rgba(245, 158, 11, 0.2);
        --l-shadow-color: rgba(0, 0, 0, 0.5);
        --l-grad-left: linear-gradient(to right, #1e293b 0%, #242e42 95%, #0f172a 100%);
        --l-grad-right: linear-gradient(to left, #1e293b 0%, #242e42 95%, #0f172a 100%);
        
        /* Table Default */
        --table-head: #1e293b;
        --table-head-text: #f59e0b;
        --table-stripe: rgba(255, 255, 255, 0.03);
        --table-border: #334155;
    }

    body.theme-light-mode {
        /* Light Mode (High Contrast Paper) */
        --l-bg-body: #ffffff; /* Pure White */
        --l-bg-book: #ffffff;
        --l-bg-sidebar: #f8fafc;
        --l-bg-surface: #f1f5f9;
        --l-bg-surface-hover: #e2e8f0;
        --l-text-primary: #1e293b; /* Slate-800 - Sharp */
        --l-text-secondary: #475569; /* Slate-600 */
        --l-border: #cbd5e1;
        --l-accent: #ea580c; /* Orange-600 */
        --l-accent-glow: rgba(234, 88, 12, 0.1);
        --l-shadow-color: rgba(0, 0, 0, 0.1);
        --l-grad-left: linear-gradient(to right, #ffffff 0%, #f8fafc 95%, #e2e8f0 100%);
        --l-grad-right: linear-gradient(to left, #ffffff 0%, #f8fafc 95%, #e2e8f0 100%);

        /* Table Light */
        --table-head: #f1f5f9;
        --table-head-text: #ea580c;
        --table-stripe: rgba(0, 0, 0, 0.03);
        --table-border: #cbd5e1;
    }

    /* Font Classes */
    .font-inter { font-family: 'Inter', sans-serif; }
    .font-merriweather { font-family: 'Merriweather', serif; }
    .font-roboto-slab { font-family: 'Roboto Slab', serif; }
    .font-inconsolata { font-family: 'Inconsolata', monospace; }
    .font-nunito { font-family: 'Nunito', sans-serif; }

    /* Active States */
    .theme-option.active-theme {
        background-color: var(--l-accent);
        color: white;
        box-shadow: 0 4px 12px var(--l-accent-glow);
    }
    .font-btn.active-font {
        border-color: var(--l-accent);
        background-color: var(--l-bg-surface-hover);
        color: var(--l-text-primary);
    }
    .font-btn:hover {
        background-color: var(--l-bg-surface-hover);
    }
    
    .lh-btn.active-lh, .align-btn.active-align {
        background-color: var(--l-accent);
        color: white;
    }
</style>

<script>
    // FIX: Using data attribute to prevent linter errors
    const lessonContainer = document.querySelector('.lesson-wrapper');
    const isUserLoggedIn = lessonContainer ? (lessonContainer.dataset.userLogged === 'true') : false;
    const currentLessonId = lessonContainer ? lessonContainer.dataset.lessonId : '';

    // Show/Hide Sticky Bar based on scroll
    const stickyBar = document.getElementById('sticky-action-bar');
    const settingsPanel = document.getElementById('reading-settings-menu');
    const article = document.getElementById('lesson-article');
    
    // Show bar after a small delay
    setTimeout(() => {
        if(stickyBar) {
            stickyBar.classList.remove('translate-y-24', 'opacity-0');
        }
    }, 1000);

    // --- NEW SETTINGS LOGIC (FIXED CLICK - SIMPLIFIED) ---
    function toggleSettingsMenu() {
        if (settingsPanel.classList.contains('hidden')) {
            // OPEN
            settingsPanel.classList.remove('hidden');
            document.getElementById('btn-settings-trigger').classList.add('text-sapereOrange', 'bg-white/10');
        } else {
            // CLOSE
            settingsPanel.classList.add('hidden');
            document.getElementById('btn-settings-trigger').classList.remove('text-sapereOrange', 'bg-white/10');
        }
    }

    // THEME LOGIC
    function setTheme(theme) {
        document.body.classList.remove('theme-light-mode');
        document.getElementById('btn-theme-dark').classList.remove('active-theme', 'text-white');
        document.getElementById('btn-theme-light').classList.remove('active-theme', 'text-white');
        document.getElementById('btn-theme-dark').classList.add('text-gray-400');
        document.getElementById('btn-theme-light').classList.add('text-gray-400');

        if (theme === 'light') {
            document.body.classList.add('theme-light-mode');
            document.getElementById('btn-theme-light').classList.add('active-theme', 'text-white');
            document.getElementById('btn-theme-light').classList.remove('text-gray-400');
        } else {
            document.getElementById('btn-theme-dark').classList.add('active-theme', 'text-white');
            document.getElementById('btn-theme-dark').classList.remove('text-gray-400');
        }
    }

    // FONT LOGIC
    const lessonContentDiv = document.getElementById('lesson-article');
    
    function setFont(fontName) {
        // Reset styles
        lessonContentDiv.style.fontFamily = '';
        document.querySelectorAll('.font-btn').forEach(btn => btn.classList.remove('active-font'));
        
        // Apply new
        if (fontName === 'Inter') lessonContentDiv.style.fontFamily = "'Inter', sans-serif";
        if (fontName === 'Merriweather') lessonContentDiv.style.fontFamily = "'Merriweather', serif";
        if (fontName === 'Roboto Slab') lessonContentDiv.style.fontFamily = "'Roboto Slab', serif";
        if (fontName === 'Inconsolata') lessonContentDiv.style.fontFamily = "'Inconsolata', monospace";
        if (fontName === 'Nunito') lessonContentDiv.style.fontFamily = "'Nunito', sans-serif";

        // Update UI highlight
        const activeBtn = Array.from(document.querySelectorAll('.font-btn')).find(b => b.getAttribute('onclick').includes(fontName));
        if (activeBtn) activeBtn.classList.add('active-font');
    }

    // LINE HEIGHT
    function setLineHeight(val) {
        lessonContentDiv.style.lineHeight = val;
        // Update UI
        document.querySelectorAll('.lh-btn').forEach(btn => btn.classList.remove('active-lh'));
        const activeBtn = Array.from(document.querySelectorAll('.lh-btn')).find(b => b.getAttribute('onclick').includes(val));
        if (activeBtn) activeBtn.classList.add('active-lh');
    }

    // TEXT ALIGN
    function setTextAlign(val) {
        lessonContentDiv.style.textAlign = val;
        // Update UI
        document.querySelectorAll('.align-btn').forEach(btn => btn.classList.remove('active-align'));
        const activeBtn = Array.from(document.querySelectorAll('.align-btn')).find(b => b.getAttribute('onclick').includes(val));
        if (activeBtn) activeBtn.classList.add('active-align');
    }

    // FONT SIZE
    let currentFontSize = 18;
    function changeFont(delta) {
        currentFontSize += delta;
        setFontSize(currentFontSize);
    }
    
    function setFontSize(size) {
        currentFontSize = parseInt(size);
        if (currentFontSize < 14) currentFontSize = 14;
        if (currentFontSize > 32) currentFontSize = 32;
        
        lessonContentDiv.style.fontSize = currentFontSize + 'px';
        document.getElementById('font-size-display').innerText = currentFontSize + 'px';
        document.getElementById('font-size-slider').value = currentFontSize;
    }

    // ZEN MODE
    function toggleZen() {
        document.body.classList.toggle('zen-mode');
        toggleSettingsMenu(); // Close menu
    }

    function switchTab(tab) {
        document.getElementById('content-toc').classList.toggle('hidden', tab !== 'toc');
        document.getElementById('content-chat').classList.toggle('hidden', tab !== 'chat');
        document.getElementById('btn-tab-toc').classList.toggle('active', tab === 'toc');
        document.getElementById('btn-tab-chat').classList.toggle('active', tab === 'chat');
    }

    function renderDynamicTables() {
        const containers = document.querySelectorAll('.js-dynamic-table');
        containers.forEach(container => {
            try {
                const rawData = container.getAttribute('data-table-content');
                let data = null;
                try { data = JSON.parse(rawData); } catch(e) { data = rawData; }

                let html = '';
                if (typeof data === 'string') {
                    html = `<div class="p-4">${data}</div>`;
                } else if (Array.isArray(data) || (typeof data === 'object' && data !== null)) {
                    html = '<table class="lesson-table w-full text-left text-sm border-collapse">';
                    let headers = [];
                    let rows = [];

                    if (Array.isArray(data)) {
                        if (data.length > 0) {
                            headers = data[0]; 
                            rows = data.slice(1);
                        }
                    } else {
                        headers = data.headers || [];
                        rows = data.rows || [];
                    }

                    if (headers && headers.length > 0) {
                        html += '<thead><tr>';
                        headers.forEach(h => { html += `<th class="p-3 font-bold border-b whitespace-nowrap">${h}</th>`; });
                        html += '</tr></thead>';
                    }
                    
                    html += '<tbody>';
                    if (rows.length > 0) {
                        rows.forEach(row => {
                            html += '<tr class="border-b last:border-0 transition hover:bg-opacity-10 hover:bg-white">';
                            if (Array.isArray(row)) {
                                row.forEach(cell => { html += `<td class="p-3 whitespace-nowrap">${cell}</td>`; });
                            } else {
                                html += `<td class="p-3 whitespace-nowrap">${row}</td>`;
                            }
                            html += '</tr>';
                        });
                    }
                    html += '</tbody></table>';
                }
                container.innerHTML = html;
            } catch (err) {
                console.error("Eroare tabel:", err);
                container.innerHTML = '<div class="p-4 text-red-500 text-xs">Eroare afișare tabel</div>';
            }
        });
    }

    function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
    
    function toggleTTS() {
        if ('speechSynthesis' in window) {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                return;
            }
            const textToRead = document.getElementById('lesson-article').innerText;
            const utterance = new SpeechSynthesisUtterance(textToRead);
            const lang = '<%= currentLangCode %>' === 'en' ? 'en-US' : '<%= currentLangCode %>' === 'it' ? 'it-IT' : 'ro-RO';
            utterance.lang = lang;
            let voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                const voice = voices.find(v => v.lang.startsWith(lang));
                if (voice) utterance.voice = voice;
            }
            window.speechSynthesis.speak(utterance);
        } else {
            alert("Browserul tău nu suportă funcționalitatea Text-to-Speech.");
        }
    }

    async function completeLesson() {
        if (event) event.preventDefault();

        const btn = document.getElementById('bar-btn-complete');
        if(btn) { 
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin text-xl"></i> <span>Se salvează...</span>'; 
            btn.disabled = true; 
            btn.style.opacity = '0.8';
            btn.style.cursor = 'wait';
        }

        try {
            const res = await fetch('/api/lesson/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonId: currentLessonId })
            });
            
            if (res.ok) {
                const data = await res.json();
                
                if (typeof showToast === 'function' && data.xpAwarded > 0) {
                    showToast(data.xpAwarded, "Lecție finalizată! + " + data.xpAwarded + " XP");
                }
                
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const data = await res.json();
                alert("Eroare: " + (data.error || "Nu s-a putut salva."));
                if(btn) window.location.reload();
            }
        } catch(e) { 
            console.error(e);
            alert("Eroare de rețea."); 
            if(btn) window.location.reload();
        }
    }

    async function resetLesson() {
        if (event) event.preventDefault();
        if(!confirm("Sigur vrei să resetezi progresul?")) return;
        
        const btn = document.getElementById('bar-btn-reset');
        if(btn) {
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i>';
            btn.disabled = true;
        }

        try {
            const res = await fetch('/api/lesson/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonId: currentLessonId })
            });
            if (res.ok) window.location.reload();
            else {
                alert("Eroare la resetare.");
                if(btn) window.location.reload();
            }
        } catch(e) { console.error(e); }
    }

    const triggerBtn = document.getElementById('selection-trigger-btn');
    const popover = document.getElementById('flashcard-popover');
    
    document.addEventListener('selectionchange', () => {
        if (!isUserLoggedIn) return; 
        const selection = window.getSelection();
        if (selection.isCollapsed || !selection.toString().trim()) {
            setTimeout(() => {
                if (document.activeElement && !popover.contains(document.activeElement) && document.activeElement !== triggerBtn) {
                     triggerBtn.classList.add('hidden');
                }
            }, 100);
            return;
        }
        const lessonContent = document.getElementById('lesson-article');
        if (lessonContent && !lessonContent.contains(selection.anchorNode)) return;
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        const top = rect.top + window.scrollY - 50;
        const left = rect.left + window.scrollX + (rect.width / 2) - 20;
        triggerBtn.style.top = `${top}px`;
        triggerBtn.style.left = `${left}px`;
        triggerBtn.classList.remove('hidden');
    });

    function openFlashcardPopover() {
        const selection = window.getSelection().toString().trim();
        if (!selection) return;
        document.getElementById('fc-front-preview').textContent = selection;
        document.getElementById('fc-back-input').value = '';
        const btnRect = triggerBtn.getBoundingClientRect();
        let top = btnRect.top + window.scrollY + 10;
        let left = btnRect.left + window.scrollX + 10;
        if (left + 320 > window.innerWidth) left = window.innerWidth - 340;
        popover.style.top = `${top}px`;
        popover.style.left = `${left}px`;
        popover.classList.remove('hidden');
        triggerBtn.classList.add('hidden');
    }

    function closeFlashcardPopover() { popover.classList.add('hidden'); }

    async function aiTranslateSelection() {
        const text = document.getElementById('fc-front-preview').textContent;
        const loader = document.getElementById('ai-loading');
        loader.classList.remove('hidden');
        try {
            const res = await fetch('/api/ai/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sourceLang: 'auto',
                    targetLang: 'ro', 
                    content: { text: text } 
                })
            });
            const data = await res.json();
            if (data && data.text) document.getElementById('fc-back-input').value = data.text;
        } catch(e) {
            console.error(e);
            alert('Eroare la traducerea AI.');
        } finally {
            loader.classList.add('hidden');
        }
    }

    async function saveFlashcardFromPopover() {
        const front = document.getElementById('fc-front-preview').textContent;
        const back = document.getElementById('fc-back-input').value;
        const btn = document.getElementById('btn-save-fc');
        if (!back.trim()) { alert("Te rog adaugă o traducere sau definiție."); return; }
        btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Se salvează...';
        btn.disabled = true;
        try {
            const res = await fetch('/api/flashcards', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    front: front,
                    back: back,
                    lessonId: currentLessonId
                })
            });
            if (res.ok) {
                closeFlashcardPopover();
                alert("Flashcard salvat cu succes!"); 
            } else {
                const err = await res.json();
                alert('Eroare: ' + err.error);
            }
        } catch(e) { alert('Eroare de rețea.'); } finally {
            btn.innerHTML = '<i class="bx bx-save"></i> Salvează în Colecție';
            btn.disabled = false;
        }
    }

    const chatContainer = document.querySelector('#tab-content-chat .space-y-4');
    const chatInputBtn = document.querySelector('#chat-input-area button');
    const chatInputField = document.querySelector('#chat-input-area input');

    async function sendMessage() {
        const content = chatInputField.value;
        if (!content.trim()) return;
        chatInputBtn.disabled = true;
        try {
            const response = await fetch('/api/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonId: currentLessonId, content: content })
            });
            const result = await response.json();
            if (response.ok) {
                appendMessageToUI(result.message.username, result.message.content, 'acum', true); 
                chatInputField.value = ''; 
            }
        } catch (e) { console.error(e); } finally { chatInputBtn.disabled = false; }
    }

    function appendMessageToUI(user, text, time, isMe) {
        const html = `
            <div class="group px-2 animate-fade-in">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full ${isMe ? 'bg-orange-600' : 'bg-blue-600'} text-white text-[9px] flex items-center justify-center font-bold">${user.charAt(0).toUpperCase()}</div>
                        <span class="text-xs font-bold ${isMe ? 'text-[var(--l-accent)]' : 'text-[var(--l-text-primary)]'}">${user}</span>
                    </div>
                    <span class="text-[9px] text-[var(--l-text-secondary)]">${time}</span>
                </div>
                <p class="text-xs text-[var(--l-text-secondary)] pl-7 leading-relaxed">${text}</p>
            </div>
        `;
        let messagesContainer = document.querySelector('#content-chat .pl-2')?.parentElement || document.getElementById('content-chat');
        const inputArea = document.getElementById('chat-input-area');
        const msgDiv = document.createElement('div');
        msgDiv.innerHTML = html;
        if (inputArea && messagesContainer.contains(inputArea)) messagesContainer.insertBefore(msgDiv, inputArea);
        else messagesContainer.appendChild(msgDiv);
        msgDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    if(chatInputBtn) chatInputBtn.addEventListener('click', sendMessage);
    if(chatInputField) chatInputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    async function loadMessages() {
        try {
            const res = await fetch(`/api/chat/${currentLessonId}`);
            const data = await res.json();
            if(data.messages && Array.isArray(data.messages)) {
                const messagesArea = document.getElementById('content-chat');
                const pinnedHeader = messagesArea.querySelector('.rounded-r-lg'); 
                const inputArea = document.getElementById('chat-input-area');
                Array.from(messagesArea.children).forEach(child => { if (child !== pinnedHeader && child !== inputArea) child.remove(); });
                data.messages.forEach(msg => {
                    appendMessageToUI(msg.username, msg.content, new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), false);
                });
            }
        } catch(e) { console.error("Eroare chat:", e); }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadMessages();
        renderDynamicTables();
    });
    
</script>

<div id="modal-notes" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center backdrop-blur-sm">
    <div class="p-6 rounded-2xl w-96 shadow-2xl" style="background: var(--l-bg-surface); border: 1px solid var(--l-border);">
        <h3 class="font-bold mb-4" style="color: var(--l-text-primary);">Notițe</h3>
        <textarea class="w-full rounded-lg p-3 outline-none h-40" style="background: var(--l-bg-body); color: var(--l-text-primary); border: 1px solid var(--l-border);"></textarea>
        <div class="flex justify-end mt-4 gap-2">
            <button onclick="toggleModal('modal-notes')" class="px-4 py-2 rounded transition hover:bg-white/10" style="color: var(--l-text-secondary);">Închide</button>
            <button class="px-4 py-2 rounded font-bold text-white transition hover:opacity-90" style="background: var(--l-accent);">Salvează</button>
        </div>
    </div>
</div>