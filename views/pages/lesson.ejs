<!-- Importăm fișierul de stiluri dedicat -->
<link rel="stylesheet" href="/css/lesson.css">

<!-- Importăm Fonturi de Lectură -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Lora:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

<!-- MathJax & JSXGraph -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />
<script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>

<%
    const currentLangCode = (typeof activeLang !== 'undefined' && activeLang.name) ? activeLang.name.toLowerCase() : 'ro';
    
    let displayData = {
        title: lesson.title,
        subtitle: lesson.subtitle,
        sections: [] 
    };

    if (lesson.content && typeof lesson.content === 'object' && !Array.isArray(lesson.content)) {
        if (lesson.content[currentLangCode] && lesson.content[currentLangCode].title) {
            displayData = lesson.content[currentLangCode];
        } else if (lesson.content['ro'] && lesson.content['ro'].title) {
            displayData = lesson.content['ro'];
        } 
    } 
    else if (Array.isArray(lesson.content)) {
        displayData.sections = lesson.content;
    }

    const categorySlugs = {
        'Matematică': 'math', 'Științe': 'science', 'Istorie': 'history', 
        'Geografie': 'geography', 'Italiana': 'italian', 'English': 'english', 'IT': 'it'
    };
    const catSlug = categorySlugs[lesson.category] || lesson.category.toLowerCase();
%>

<!-- Breadcrumbs -->
<nav aria-label="Breadcrumb" id="breadcrumbs" class="max-w-[1400px] mx-auto px-4 pt-24 pb-2 flex items-center gap-2 text-sm opacity-70 transition-opacity hover:opacity-100" style="color: var(--l-text-secondary);">
    <a href="/" aria-label="Acasa" class="hover:text-[var(--l-accent)] transition"><i class='bx bx-home'></i></a>
    <span aria-hidden="true">/</span>
    <a href="/#materii" class="hover:text-[var(--l-accent)] transition"><%= __('lesson.breadcrumbs.subjects') %></a>
    <span aria-hidden="true">/</span>
    <a href="/materii/<%= catSlug %>" class="hover:text-[var(--l-accent)] transition font-medium">
        <%= lesson.category %>
    </a>
    <span aria-hidden="true">/</span>
    <span style="color: var(--l-accent); font-weight: bold;" class="truncate max-w-[200px]" aria-current="page"><%= displayData.title %></span>
</nav>

<div class="lesson-wrapper">
    <!-- CARTEA 3D -->
    <div class="book-frame">
        
        <!-- Cotorul Central -->
        <div class="book-spine"></div>
        
        <!-- === SIDEBAR (Stanga) === -->
        <aside class="book-panel panel-left">
            
            <!-- Conținut Scrollabil Sidebar -->
            <div class="sidebar-content custom-scroll">
                
                <!-- Header -->
                <div class="lesson-header mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="badge-category">
                            INFO.01
                        </span>
                        <span style="color: var(--l-text-secondary); font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                            <i class='bx bx-category'></i> <%= lesson.category %>
                        </span>
                    </div>
                    <h1><%= displayData.title %></h1>
                </div>

                <!-- Tab Switcher -->
                <div class="tab-switcher">
                    <button onclick="switchTab('toc')" id="btn-tab-toc" class="tab-btn active">Cuprins</button>
                    <button onclick="switchTab('chat')" id="btn-tab-chat" class="tab-btn">Întrebări</button>
                </div>

                <!-- TAB: Cuprins -->
                <div id="content-toc" class="space-y-1 transition-opacity duration-300">
                    <% if (displayData.sections) { %>
                        <% displayData.sections.forEach((section, index) => { %>
                            <a href="#sec-<%= index %>" class="block px-3 py-2 rounded-lg transition-colors duration-200 hover:bg-[var(--l-bg-surface-hover)]" style="color: var(--l-text-secondary);" data-target="sec-<%= index %>">
                                <div class="flex items-start gap-3">
                                    <span style="font-family: monospace; opacity: 0.5; padding-top: 2px;"><%= (index + 1).toString().padStart(2, '0') %></span>
                                    <span style="font-weight: 500;"><%= section.title %></span>
                                </div>
                            </a>
                        <% }) %>
                    <% } %>
                    
                    <!-- Support Widget -->
                    <div class="mt-8 p-4 rounded-xl border border-dashed text-center cursor-pointer transition hover:scale-[1.02]" style="border-color: var(--l-border); background: var(--l-bg-surface-hover);" onclick="window.open('#', '_blank')">
                        <i class='bx bxs-coffee-togo text-2xl mb-1' style="color: var(--l-text-secondary);"></i>
                        <p style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--l-text-secondary);">Susține Proiectul</p>
                    </div>
                </div>

                <!-- TAB: Chat -->
                <div id="content-chat" class="hidden space-y-4">
                    <div class="p-3 rounded-r-lg border-l-4" style="background: var(--l-accent-glow); border-color: var(--l-accent);">
                        <p style="font-size: 0.8rem; color: var(--l-text-primary);">
                            <span style="font-weight: 800; color: var(--l-accent);">SapereBot:</span> Ai nelămuriri? Comunitatea te poate ajuta aici.
                        </p>
                    </div>
                  
                    
                    <!-- Chat Input (Moved Inside Content for Mobile Flow) -->
                    <div id="chat-input-area" class="relative mt-4">
                        <input type="text" placeholder="Adaugă o întrebare...">
                        <button><i class='bx bxs-send'></i></button>
                    </div>
                </div>

            </div>

            <!-- Utility Dock (Floating) -->
            <div class="utility-dock">
                <!-- Settings Trigger -->
                <button onclick="toggleSettings()" class="dock-btn" title="Setări">
                    <i class='bx bx-slider-alt text-xl'></i>
                </button>

                <div style="width: 1px; height: 20px; background: var(--l-border);"></div>

                <!-- Notes -->
                <button onclick="toggleModal('modal-notes')" class="dock-btn" title="Notițe">
                    <i class='bx bx-edit-alt text-xl'></i>
                </button>

                <!-- Timer -->
                <div onclick="toggleTimer()" id="dock-timer" class="timer-widget">
                    <i class='bx bx-timer text-lg'></i>
                    <span id="timer-display">25:00</span>
                </div>

                <!-- TTS -->
                <button onclick="toggleTTS()" id="btn-tts" class="dock-btn primary shadow-lg ml-auto" title="Ascultă">
                    <i class='bx bx-play text-2xl'></i>
                </button>
            </div>

            <!-- Settings Popover -->
            <div id="settings-popover" class="settings-popover">
                <div class="flex justify-between items-center mb-4 pb-2 border-b" style="border-color: var(--l-border);">
                    <span style="font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--l-text-secondary);">Setări Lectură</span>
                    <button onclick="toggleSettings()"><i class='bx bx-x text-lg' style="color: var(--l-text-secondary);"></i></button>
                </div>
                
                <!-- Font Size -->
                <div class="flex items-center justify-between mb-4 p-2 rounded-lg" style="background: var(--l-bg-surface-hover);">
                    <button onclick="changeFont(-1)" class="dock-btn">A-</button>
                    <span style="font-size: 0.7rem; font-weight: 700; color: var(--l-text-primary);">FONT</span>
                    <button onclick="changeFont(1)" class="dock-btn">A+</button>
                </div>

                <!-- Themes -->
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="setTheme('dark')" class="p-2 rounded border transition hover:border-[var(--l-accent)] flex flex-col items-center gap-1" style="background: #0f172a; border-color: transparent;">
                        <div class="w-3 h-3 rounded-full bg-[#1e293b]"></div>
                        <span class="text-[9px] text-white font-bold">Dark</span>
                    </button>
                    <button onclick="setTheme('sepia')" class="p-2 rounded border transition hover:border-[var(--l-accent)] flex flex-col items-center gap-1" style="background: #f0e6d2; border-color: transparent;">
                        <div class="w-3 h-3 rounded-full bg-[#eaddcf]"></div>
                        <span class="text-[9px] text-[#433422] font-bold">Sepia</span>
                    </button>
                    <button onclick="setTheme('light')" class="p-2 rounded border transition hover:border-[var(--l-accent)] flex flex-col items-center gap-1" style="background: #f8fafc; border-color: transparent;">
                        <div class="w-3 h-3 rounded-full bg-white border border-gray-200"></div>
                        <span class="text-[9px] text-[#0f172a] font-bold">Light</span>
                    </button>
                </div>

                <!-- Zen Mode -->
                <button onclick="toggleZen()" class="w-full py-2 rounded-lg font-bold text-xs transition flex items-center justify-center gap-2" style="background: var(--l-bg-surface-hover); color: var(--l-text-secondary);">
                    <i class='bx bx-expand'></i> Mod Zen
                </button>
            </div>

        </aside>

        <!-- === PAGE RIGHT (Conținut) === -->
        <article class="book-panel panel-right">
            <span class="absolute top-4 right-4 text-[10px] font-mono opacity-50 page-corner" style="color: var(--l-text-secondary);">PG. 1</span>
            
            <div class="lesson-content custom-scroll" id="lesson-article" style="font-size: 18px;">
                <% if (displayData.sections && displayData.sections.length > 0) { %>
                    <% displayData.sections.forEach((section, index) => { %>
                        <section id="sec-<%= index %>" class="mb-16">
                            <!-- Titlu Secțiune -->
                            <div class="flex items-end gap-3 mb-6 pb-2 border-b" style="border-color: var(--l-border);">
                                <span style="font-size: 2.5em; font-family: serif; font-weight: 700; color: var(--l-accent); opacity: 0.3; line-height: 0.8;"><%= index + 1 %></span>
                                <h2 style="margin: 0; border: none; padding: 0;"><%= section.title %></h2>
                            </div>

                            <!-- Conținut Blocuri -->
                            <div style="color: var(--l-text-secondary);">
                                <% section.blocks.forEach((block, bIndex) => { %>
                                    <% if (block.type === 'paragraph') { %>
                                        <div class="ql-editor !p-0 !h-auto text-lg" style="font-size: 1em !important;"><%- block.content %></div>
                                    <% } %>
                                    
                                    <% if (block.type === 'definition') { %>
                                        <div class="block-definition">
                                            <h4><i class='bx bx-book-open'></i> <%= block.term %></h4>
                                            <p><%= block.description %></p>
                                        </div>
                                    <% } %>

                                    <% if (block.type === 'geometry') { %>
                                        <div class="my-8 relative z-10">
                                            <div id="geo-view-<%= index %>-<%= bIndex %>" class="w-full aspect-square md:aspect-video rounded-xl border shadow-lg bg-white" style="border-color: var(--l-border);"></div>
                                            <!-- Salvăm codul într-un template script sigur, nu direct în JS -->
                                            <script type="text/template" id="geo-code-<%= index %>-<%= bIndex %>"><%- block.code %></script>
                                            <script>
                                                (function() {
                                                    const boardId = 'geo-view-<%= index %>-<%= bIndex %>';
                                                    const codeId = 'geo-code-<%= index %>-<%= bIndex %>';
                                                    window.addEventListener('load', function() {
                                                        if (typeof JXG !== 'undefined') {
                                                            try {
                                                                const board = JXG.JSXGraph.initBoard(boardId, { boundingbox: [-5, 5, 5, -5], axis: true, showCopyright: false, pan: { enabled: true }, zoom: { enabled: true } });
                                                                // Citim codul din elementul template
                                                                const code = document.getElementById(codeId).textContent;
                                                                new Function('board', code)(board);
                                                            } catch(e) { console.error(e); }
                                                        }
                                                    });
                                                })();
                                            </script>
                                        </div>
                                    <% } %>
                                <% }) %>
                            </div>
                        </section>
                    <% }) %>
                <% } %>
                
                <!-- Footer Lecție -->
                <div class="mt-12 pt-8 border-t border-dashed text-center" style="border-color: var(--l-border); padding-bottom: 5rem;">
                    <h3 style="font-family: serif; font-weight: 700; font-size: 1.25em; color: var(--l-text-primary);"><%= __('lesson.footer.title') %></h3>
                    <p style="font-size: 0.85em; color: var(--l-text-secondary);"><%= __('lesson.footer.subtitle') %></p>
                </div>
            </div>
        </article>

    </div>
</div>

<!-- JS Logic -->
<script>
    // --- TABS ---
    function switchTab(tab) {
        document.getElementById('content-toc').classList.toggle('hidden', tab !== 'toc');
        document.getElementById('content-chat').classList.toggle('hidden', tab !== 'chat');
        
        document.getElementById('btn-tab-toc').classList.toggle('active', tab === 'toc');
        document.getElementById('btn-tab-chat').classList.toggle('active', tab === 'chat');
        
        // Mobile Chat Input Visibility logic handled by CSS (+ selector)
    }

    // --- SETTINGS ---
    function toggleSettings() {
        document.getElementById('settings-popover').classList.toggle('open');
    }

    function toggleModal(id) {
        const el = document.getElementById(id);
        el.classList.toggle('hidden');
    }

    // --- THEMES ---
    function setTheme(theme) {
        document.body.classList.remove('theme-light-mode', 'theme-sepia-mode');
        if (theme === 'light') document.body.classList.add('theme-light-mode');
        if (theme === 'sepia') document.body.classList.add('theme-sepia-mode');
    }

    function changeFont(dir) {
        const content = document.getElementById('lesson-article');
        // Citim font-size-ul curent (care e setat inline sau computat)
        let current = parseInt(content.style.fontSize) || 18;
        let newSize = current + dir;
        
        // Limite
        if (newSize < 12) newSize = 12;
        if (newSize > 28) newSize = 28;

        content.style.fontSize = newSize + 'px';
    }

    function toggleZen() {
        document.body.classList.toggle('zen-mode');
        
        // Pe mobil, zen mode trebuie sa permita scroll pe body (handled in CSS)
        // Pe desktop, full screen API
        if (window.innerWidth > 1024) {
            if (document.body.classList.contains('zen-mode')) {
                document.documentElement.requestFullscreen().catch(e => {});
            } else {
                if (document.fullscreenElement) document.exitFullscreen();
            }
        }
        
        toggleSettings(); // Close popover
    }

    // --- TIMER ---
    let timerInt;
    let time = 1500;
    function toggleTimer() {
        const el = document.getElementById('timer-display');
        const icon = document.querySelector('#dock-timer i');
        if (timerInt) {
            clearInterval(timerInt);
            timerInt = null;
            icon.className = 'bx bx-timer text-lg';
        } else {
            icon.className = 'bx bx-pause text-lg';
            timerInt = setInterval(() => {
                time--;
                // Folosim '0' ca string pentru padStart pentru a fi safe
                const m = Math.floor(time / 60).toString().padStart(2, '0');
                const s = (time % 60).toString().padStart(2, '0');
                el.innerText = `${m}:${s}`;
                if (time <= 0) { clearInterval(timerInt); alert("Pauză!"); time = 1500; }
            }, 1000);
        }
    }

    // --- TTS Placeholder ---
    function toggleTTS() { alert("Funcționalitate TTS activată (Demo)"); }

 // --- LOGICA CHAT ---
    const chatContainer = document.querySelector('#tab-content-chat .space-y-4'); // Containerul de mesaje
    const chatInputBtn = document.querySelector('#chat-input-area button');
    const chatInputField = document.querySelector('#chat-input-area input');
    
    // ID-ul lecției (trebuie să fie disponibil în EJS, de exemplu prin variabila lesson.id)
    const currentLessonId = "<%= lesson.id %>"; 

    // Funcție pentru trimitere mesaj
    async function sendMessage() {
        const content = chatInputField.value;
        if (!content.trim()) return;

        // Dezactivăm butonul temporar
        chatInputBtn.disabled = true;
        chatInputBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i>';

        try {
            const response = await fetch('/api/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lessonId: currentLessonId,
                    content: content
                })
            });

            const result = await response.json();

            if (response.ok) {
                // Adăugăm mesajul în UI imediat
                // Folosim result.message returnat de server pentru date exacte
                appendMessageToUI(result.message.username, result.message.content, 'acum', true); 
                chatInputField.value = ''; // Golim inputul
                
                // Scroll la ultimul mesaj
                const messagesArea = document.getElementById('content-chat'); // Asigură-te că ID-ul e corect în HTML
                if(messagesArea) messagesArea.scrollTop = messagesArea.scrollHeight;
            } else {
                console.error("Eroare server:", result);
                alert('Eroare: ' + (result.error || 'Nu s-a putut trimite.'));
            }
        } catch (e) {
            console.error(e);
            alert('Eroare de rețea.');
        } finally {
            chatInputBtn.disabled = false;
            chatInputBtn.innerHTML = '<i class="bx bxs-send"></i>';
        }
    }

    // Funcție helper pentru a adăuga HTML în chat
    function appendMessageToUI(user, text, time, isMe) {
        const html = `
            <div class="group px-2 animate-fade-in">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full ${isMe ? 'bg-orange-600' : 'bg-blue-600'} text-white text-[9px] flex items-center justify-center font-bold">
                            ${user.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-xs font-bold ${isMe ? 'text-[var(--l-accent)]' : 'text-[var(--l-text-primary)]'}">${user}</span>
                    </div>
                    <span class="text-[9px] text-[var(--l-text-secondary)]">${time}</span>
                </div>
                <p class="text-xs text-[var(--l-text-secondary)] pl-7 leading-relaxed">${text}</p>
            </div>
        `;
        
        // Identificăm containerul corect pentru mesaje
        // Notă: În layout-ul tău anterior, mesajele erau într-un div specific, nu direct în #content-chat
        // Căutăm containerul de mesaje sau îl folosim pe cel principal
        let messagesContainer = document.querySelector('#content-chat .pl-2')?.parentElement || document.getElementById('content-chat');
        
        // Dacă există un input area în container, inserăm înainte de el
        const inputArea = document.getElementById('chat-input-area');
        
        const msgDiv = document.createElement('div');
        msgDiv.innerHTML = html;
        
        if (inputArea && messagesContainer.contains(inputArea)) {
            messagesContainer.insertBefore(msgDiv, inputArea);
        } else {
            messagesContainer.appendChild(msgDiv);
        }
        
        // Scroll la elementul nou
        msgDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    // Event Listeners
    if(chatInputBtn) chatInputBtn.addEventListener('click', sendMessage);
    if(chatInputField) {
        chatInputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    }

    // Încărcare mesaje inițiale
    async function loadMessages() {
        try {
            const res = await fetch(`/api/chat/${currentLessonId}`);
            const data = await res.json();
            
            if(data.messages && Array.isArray(data.messages)) {
                // Găsim zona de mesaje și o curățăm de mesajele demo, păstrând header-ul pinned
                const messagesArea = document.getElementById('content-chat');
                const pinnedHeader = messagesArea.querySelector('.rounded-r-lg'); // Headerul SapereBot
                const inputArea = document.getElementById('chat-input-area');
                
                // Eliminăm mesajele vechi (tot ce nu e header sau input)
                Array.from(messagesArea.children).forEach(child => {
                    if (child !== pinnedHeader && child !== inputArea) {
                        child.remove();
                    }
                });

                // Adăugăm mesajele din DB
                // Presupunem că user-ul curent e disponibil global sau prin verificare simplă
                // Pentru demo, considerăm tot ce nu e 'eu' ca fiind altcineva, logica exactă necesită user ID din sesiune
                data.messages.forEach(msg => {
                    // Verificare simplistă pentru demo - ideal compari msg.user_id cu id-ul utilizatorului logat
                    const isMe = false; 
                    appendMessageToUI(msg.username, msg.content, new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), isMe);
                });
            }
        } catch(e) { console.error("Eroare la încărcarea mesajelor:", e); }
    }
    
    // Apelăm încărcarea la pornire
    document.addEventListener('DOMContentLoaded', loadMessages);
    
</script>

<!-- Note Modal -->
<div id="modal-notes" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center backdrop-blur-sm">
    <div class="p-6 rounded-2xl w-96 shadow-2xl" style="background: var(--l-bg-surface); border: 1px solid var(--l-border);">
        <h3 class="font-bold mb-4" style="color: var(--l-text-primary);">Notițe</h3>
        <textarea class="w-full rounded-lg p-3 outline-none h-40" style="background: var(--l-bg-body); color: var(--l-text-primary); border: 1px solid var(--l-border);"></textarea>
        <div class="flex justify-end mt-4 gap-2">
            <button onclick="toggleModal('modal-notes')" class="px-4 py-2 rounded transition hover:bg-white/10" style="color: var(--l-text-secondary);">Închide</button>
            <button class="px-4 py-2 rounded font-bold text-white transition hover:opacity-90" style="background: var(--l-accent);">Salvează</button>
        </div>
    </div>
</div>