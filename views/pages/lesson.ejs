<!-- Importăm fișierul de stiluri dedicat -->
<link rel="stylesheet" href="/css/lesson.css">

<!-- Importăm Fonturi de Lectură -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Lora:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

<!-- MathJax & JSXGraph -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />
<script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>

<%
    // Determinăm limba curentă (fallback pe 'ro')
    const currentLangCode = (typeof activeLang !== 'undefined' && activeLang.name) ? activeLang.name.toLowerCase() : 'ro';
    
    // Pregătim datele de afișare
    let displayData = {
        title: lesson.title,
        subtitle: lesson.subtitle,
        sections: [] 
    };

    // Gestionăm structura de conținut (obiect multilanguage vs array simplu)
    if (lesson.content && typeof lesson.content === 'object' && !Array.isArray(lesson.content)) {
        if (lesson.content[currentLangCode] && lesson.content[currentLangCode].title) {
            displayData = lesson.content[currentLangCode];
        } else if (lesson.content['ro'] && lesson.content['ro'].title) {
            displayData = lesson.content['ro'];
        } 
    } 
    else if (Array.isArray(lesson.content)) {
        displayData.sections = lesson.content;
    }

    // Mapare pentru slug-uri de categorii
    const categorySlugs = {
        'Matematică': 'math', 'Științe': 'science', 'Istorie': 'history', 
        'Geografie': 'geography', 'Italiana': 'italian', 'English': 'english', 'IT': 'it'
    };
    const catSlug = categorySlugs[lesson.category] || lesson.category.toLowerCase();
%>

<!-- Breadcrumbs -->
<nav aria-label="Breadcrumb" id="breadcrumbs" class="max-w-[1400px] mx-auto px-4 pt-24 pb-2 flex items-center gap-2 text-sm opacity-70 transition-opacity hover:opacity-100" style="color: var(--l-text-secondary);">
    <a href="/" aria-label="Acasa" class="hover:text-[var(--l-accent)] transition"><i class='bx bx-home'></i></a>
    <span aria-hidden="true">/</span>
    <a href="/#materii" class="hover:text-[var(--l-accent)] transition"><%= __('lesson.breadcrumbs.subjects') %></a>
    <span aria-hidden="true">/</span>
    <a href="/materii/<%= catSlug %>" class="hover:text-[var(--l-accent)] transition font-medium">
        <%= lesson.category %>
    </a>
    <span aria-hidden="true">/</span>
    <span style="color: var(--l-accent); font-weight: bold;" class="truncate max-w-[200px]" aria-current="page"><%= displayData.title %></span>
</nav>

<div class="lesson-wrapper">
    <!-- CARTEA 3D -->
    <div class="book-frame">
        
        <!-- Cotorul Central -->
        <div class="book-spine"></div>
        
        <!-- === SIDEBAR (Stanga) === -->
        <aside class="book-panel panel-left">
            
            <!-- Conținut Scrollabil Sidebar -->
            <div class="sidebar-content custom-scroll">
                
                <!-- Header -->
                <div class="lesson-header mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="badge-category">
                            INFO.01
                        </span>
                        <span style="color: var(--l-text-secondary); font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                            <i class='bx bx-category'></i> <%= lesson.category %>
                        </span>
                    </div>
                    <h1><%= displayData.title %></h1>
                </div>

                <!-- Tab Switcher -->
                <div class="tab-switcher">
                    <button onclick="switchTab('toc')" id="btn-tab-toc" class="tab-btn active">Cuprins</button>
                    <button onclick="switchTab('chat')" id="btn-tab-chat" class="tab-btn">Întrebări</button>
                </div>

                <!-- TAB: Cuprins -->
                <div id="content-toc" class="space-y-1 transition-opacity duration-300">
                    <% if (displayData.sections) { %>
                        <% displayData.sections.forEach((section, index) => { %>
                            <a href="#sec-<%= index %>" class="block px-3 py-2 rounded-lg transition-colors duration-200 hover:bg-[var(--l-bg-surface-hover)]" style="color: var(--l-text-secondary);" data-target="sec-<%= index %>">
                                <div class="flex items-start gap-3">
                                    <span style="font-family: monospace; opacity: 0.5; padding-top: 2px;"><%= (index + 1).toString().padStart(2, '0') %></span>
                                    <span style="font-weight: 500;"><%= section.title %></span>
                                </div>
                            </a>
                        <% }) %>
                    <% } %>
                    
                    <!-- Support Widget -->
                    <div class="mt-8 p-4 rounded-xl border border-dashed text-center cursor-pointer transition hover:scale-[1.02]" style="border-color: var(--l-border); background: var(--l-bg-surface-hover);" onclick="window.open('https://buymeacoffee.com/sapperepluk', '_blank')">
                        <i class='bx bxs-coffee-togo text-2xl mb-1' style="color: var(--l-text-secondary);"></i>
                        <p style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--l-text-secondary);">Susține Proiectul</p>
                    </div>
                </div>

                <!-- TAB: Chat -->
                <div id="content-chat" class="hidden space-y-4">
                    <div class="p-3 rounded-r-lg border-l-4" style="background: var(--l-accent-glow); border-color: var(--l-accent);">
                        <p style="font-size: 0.8rem; color: var(--l-text-primary);">
                            <span style="font-weight: 800; color: var(--l-accent);">SapereBot:</span> Ai nelămuriri? Comunitatea te poate ajuta aici.
                        </p>
                    </div>
                  
                    <!-- Chat Input (Moved Inside Content for Mobile Flow) -->
                    <div id="chat-input-area" class="relative mt-4">
                        <input type="text" placeholder="Adaugă o întrebare...">
                        <button><i class='bx bxs-send'></i></button>
                    </div>
                </div>

            </div>

            <!-- Utility Dock (Floating) -->
            <div class="utility-dock">
                <!-- Settings Trigger -->
                <button onclick="toggleSettings()" class="dock-btn" title="Setări">
                    <i class='bx bx-slider-alt text-xl'></i>
                </button>

                <div style="width: 1px; height: 20px; background: var(--l-border);"></div>

                <!-- Notes -->
                <button onclick="toggleModal('modal-notes')" class="dock-btn" title="Notițe">
                    <i class='bx bx-edit-alt text-xl'></i>
                </button>

                <!-- Timer -->
                <div onclick="toggleTimer()" id="dock-timer" class="timer-widget">
                    <i class='bx bx-timer text-lg'></i>
                    <span id="timer-display">25:00</span>
                </div>

                <!-- TTS -->
                <button onclick="toggleTTS()" id="btn-tts" class="dock-btn primary shadow-lg ml-auto" title="Ascultă">
                    <i class='bx bx-play text-2xl'></i>
                </button>
            </div>

            <!-- Settings Popover -->
            <div id="settings-popover" class="settings-popover">
                <div class="flex justify-between items-center mb-4 pb-2 border-b" style="border-color: var(--l-border);">
                    <span style="font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--l-text-secondary);">Setări Lectură</span>
                    <button onclick="toggleSettings()"><i class='bx bx-x text-lg' style="color: var(--l-text-secondary);"></i></button>
                </div>
                
                <!-- Font Size -->
                <div class="flex items-center justify-between mb-4 p-2 rounded-lg" style="background: var(--l-bg-surface-hover);">
                    <button onclick="changeFont(-1)" class="dock-btn">A-</button>
                    <span style="font-size: 0.7rem; font-weight: 700; color: var(--l-text-primary);">FONT</span>
                    <button onclick="changeFont(1)" class="dock-btn">A+</button>
                </div>

                <!-- Themes -->
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="setTheme('dark')" class="p-2 rounded border transition hover:border-[var(--l-accent)] flex flex-col items-center gap-1" style="background: #0f172a; border-color: transparent;">
                        <div class="w-3 h-3 rounded-full bg-[#1e293b]"></div>
                        <span class="text-[9px] text-white font-bold">Dark</span>
                    </button>
                    <button onclick="setTheme('sepia')" class="p-2 rounded border transition hover:border-[var(--l-accent)] flex flex-col items-center gap-1" style="background: #f0e6d2; border-color: transparent;">
                        <div class="w-3 h-3 rounded-full bg-[#eaddcf]"></div>
                        <span class="text-[9px] text-[#433422] font-bold">Sepia</span>
                    </button>
                    <button onclick="setTheme('light')" class="p-2 rounded border transition hover:border-[var(--l-accent)] flex flex-col items-center gap-1" style="background: #f8fafc; border-color: transparent;">
                        <div class="w-3 h-3 rounded-full bg-white border border-gray-200"></div>
                        <span class="text-[9px] text-[#0f172a] font-bold">Light</span>
                    </button>
                </div>

                <!-- Zen Mode -->
                <button onclick="toggleZen()" class="w-full py-2 rounded-lg font-bold text-xs transition flex items-center justify-center gap-2" style="background: var(--l-bg-surface-hover); color: var(--l-text-secondary);">
                    <i class='bx bx-expand'></i> Mod Zen
                </button>
            </div>

        </aside>

        <!-- === PAGE RIGHT (Conținut) === -->
        <article class="book-panel panel-right">
            <span class="absolute top-4 right-4 text-[10px] font-mono opacity-50 page-corner" style="color: var(--l-text-secondary);">PG. 1</span>
            
            <div class="lesson-content custom-scroll" id="lesson-article" style="font-size: 18px;">
                <% if (displayData.sections && displayData.sections.length > 0) { %>
                    <% displayData.sections.forEach((section, index) => { %>
                        <section id="sec-<%= index %>" class="mb-16">
                            <!-- Titlu Secțiune -->
                            <div class="flex items-end gap-3 mb-6 pb-2 border-b" style="border-color: var(--l-border);">
                                <span style="font-size: 2.5em; font-family: serif; font-weight: 700; color: var(--l-accent); opacity: 0.3; line-height: 0.8;"><%= index + 1 %></span>
                                <h2 style="margin: 0; border: none; padding: 0;"><%= section.title %></h2>
                            </div>

                            <!-- Conținut Blocuri -->
                            <div style="color: var(--l-text-secondary);">
                                <!-- PROTECȚIE: Verificăm dacă există blocuri înainte de iterare -->
                                <% if (section.blocks && Array.isArray(section.blocks)) { %>
                                    <% section.blocks.forEach((block, bIndex) => { %>
                                        
                                        <!-- 1. BLOC PARAGRAF -->
                                        <% if (block.type === 'paragraph') { %>
                                            <div class="ql-editor !p-0 !h-auto text-lg mb-6" style="font-size: 1em !important; color: var(--l-text-secondary);">
                                                <%- block.content %>
                                            </div>
                                        <% } %>

                                        <!-- 2. BLOC TITLU -->
                                        <% if (block.type === 'title') { %>
                                            <h3 class="text-2xl font-bold mt-8 mb-4" style="color: var(--l-text-primary); font-family: serif;">
                                                <%= block.content %>
                                            </h3>
                                        <% } %>

                                        <!-- 3. BLOC LISTĂ -->
                                        <% if (block.type === 'list') { %>
                                            <ul class="list-disc pl-6 space-y-2 mb-6" style="color: var(--l-text-secondary);">
                                                <% if (block.items && Array.isArray(block.items)) { %>
                                                    <% block.items.forEach(item => { %>
                                                        <li class="pl-2"><%= item %></li>
                                                    <% }) %>
                                                <% } %>
                                            </ul>
                                        <% } %>

                                        <!-- 4. BLOC DEFINIȚIE -->
                                        <% if (block.type === 'definition') { %>
                                            <div class="block-definition mb-6 p-4 rounded-xl border-l-4 border-cyan-500 bg-[var(--l-bg-surface-hover)]">
                                                <h4 class="font-bold mb-1 text-cyan-600 dark:text-cyan-400 flex items-center gap-2">
                                                    <i class='bx bx-book-open'></i> <%= block.term %>
                                                </h4>
                                                <p style="color: var(--l-text-secondary); font-style: italic;"><%= block.description %></p>
                                            </div>
                                        <% } %>

                                        <!-- 5. BLOC FORMULĂ -->
                                        <% if (block.type === 'formula') { %>
                                            <div class="my-6 p-6 rounded-xl text-center border transition hover:border-[var(--l-accent)]" 
                                                 style="background: var(--l-bg-surface-hover); border-color: var(--l-border);">
                                                <div class="text-xl overflow-x-auto py-2" style="color: var(--l-text-primary);">
                                                    $$<%= block.content %>$$
                                                </div>
                                                <% if (block.explanation) { %>
                                                    <p class="text-sm mt-3 opacity-70" style="color: var(--l-text-secondary);">
                                                        <i class='bx bx-info-circle'></i> <%= block.explanation %>
                                                    </p>
                                                <% } %>
                                            </div>
                                        <% } %>

                                        <!-- 6. BLOC TABEL (STILIZAT PRIN CLASA CSS) -->
                                        <% if (block.type === 'table') { %>
                                            <% 
                                                // Serializăm datele pentru a fi procesate de JS în browser
                                                let safeTableData = block.content;
                                                if (typeof safeTableData !== 'string') {
                                                    safeTableData = JSON.stringify(safeTableData);
                                                }
                                            %>
                                            <div class="my-8 overflow-x-auto rounded-xl border border-slate-700 shadow-md js-dynamic-table" 
                                                 data-table-content="<%= safeTableData %>">
                                                <!-- Conținutul va fi generat de JS cu clasa .lesson-table -->
                                                <div class="p-4 text-center text-xs opacity-50">Se încarcă tabelul...</div>
                                            </div>
                                        <% } %>

                                        <!-- 7. BLOC GEOMETRIE -->
                                        <% if (block.type === 'geometry') { %>
                                            <div class="my-8 relative z-10">
                                                <div id="geo-view-<%= index %>-<%= bIndex %>" class="w-full aspect-square md:aspect-video rounded-xl border shadow-lg bg-white" style="border-color: var(--l-border);"></div>
                                                <script type="text/template" id="geo-code-<%= index %>-<%= bIndex %>"><%- block.code %></script>
                                                <script>
                                                    (function() {
                                                        const boardId = 'geo-view-<%= index %>-<%= bIndex %>';
                                                        const codeId = 'geo-code-<%= index %>-<%= bIndex %>';
                                                        window.addEventListener('load', function() {
                                                            if (typeof JXG !== 'undefined') {
                                                                try {
                                                                    const board = JXG.JSXGraph.initBoard(boardId, { boundingbox: [-5, 5, 5, -5], axis: true, showCopyright: false, pan: { enabled: true }, zoom: { enabled: true } });
                                                                    const code = document.getElementById(codeId).textContent;
                                                                    new Function('board', code)(board);
                                                                } catch(e) { console.error(e); }
                                                            }
                                                        });
                                                    })();
                                                </script>
                                            </div>
                                        <% } %>

                                        <!-- 8. BLOC RESURSĂ (DETECTARE INTELIGENTĂ MEDIA) -->
                                        <% if (block.type === 'resource') { %>
                                            <% 
                                                const url = block.url || '';
                                                // Detectare YouTube
                                                const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');
                                                // Detectare Imagine (extensii comune)
                                                // Adăugăm un check pentru string-uri de tip query param (ex: firebasestorage) care pot conține imagine
                                                const isImage = url.match(/\.(jpeg|jpg|gif|png|webp|bmp|svg)/i) != null 
                                                                || (url.includes('firebasestorage') && url.includes('alt=media'));
                                            %>

                                            <div class="my-8">
                                                <% if (isYouTube) { %>
                                                    <!-- YOUTUBE EMBED -->
                                                    <div class="aspect-video rounded-xl overflow-hidden border shadow-lg" style="border-color: var(--l-border);">
                                                        <iframe width="100%" height="100%" 
                                                            src="<%= url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/') %>" 
                                                            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                                                        </iframe>
                                                    </div>
                                                    <% if (block.title) { %>
                                                        <p class="text-center text-sm mt-2 opacity-70 italic" style="color: var(--l-text-secondary);"><%= block.title %></p>
                                                    <% } %>

                                                <% } else if (isImage) { %>
                                                    <!-- IMAGINE -->
                                                    <div class="rounded-xl overflow-hidden border shadow-lg" style="border-color: var(--l-border);">
                                                        <img src="<%= url %>" alt="<%= block.title || 'Imagine Lecție' %>" class="w-full h-auto object-cover" loading="lazy">
                                                    </div>
                                                    <% if (block.title) { %>
                                                        <p class="text-center text-sm mt-2 opacity-70 italic" style="color: var(--l-text-secondary);"><%= block.title %></p>
                                                    <% } %>

                                                <% } else { %>
                                                    <!-- LINK GENERIC / PDF -->
                                                    <a href="<%= url %>" target="_blank" class="flex items-center gap-4 p-4 rounded-xl border transition group hover:scale-[1.01]" 
                                                       style="background: var(--l-bg-surface-hover); border-color: var(--l-border);">
                                                        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl shrink-0" 
                                                             style="background: var(--l-accent-glow); color: var(--l-accent);">
                                                            <i class='bx <%= block.resourceType === 'pdf' ? 'bxs-file-pdf' : 'bx-link' %>'></i>
                                                        </div>
                                                        <div class="flex-1 min-w-0">
                                                            <h4 class="font-bold text-sm mb-1 group-hover:text-[var(--l-accent)] transition truncate" style="color: var(--l-text-primary);">
                                                                <%= block.title || 'Resursă Externă' %>
                                                            </h4>
                                                            <p class="text-xs truncate opacity-70" style="color: var(--l-text-secondary);">
                                                                <% 
                                                                    let displayUrl = url;
                                                                    try {
                                                                        let urlToParse = displayUrl.startsWith('http') ? displayUrl : 'https://' + displayUrl;
                                                                        const urlObj = new URL(urlToParse);
                                                                        displayUrl = urlObj.hostname;
                                                                        if(displayUrl.startsWith('www.')) displayUrl = displayUrl.substring(4);
                                                                    } catch(e) {
                                                                        if (displayUrl.length > 30) displayUrl = displayUrl.substring(0, 27) + '...';
                                                                    }
                                                                %>
                                                                <i class='bx bx-globe'></i> <%= displayUrl %>
                                                            </p>
                                                        </div>
                                                        <div class="p-2 rounded-lg bg-[var(--l-bg-body)] text-[var(--l-text-primary)]">
                                                            <i class='bx bx-link-external text-lg'></i>
                                                        </div>
                                                    </a>
                                                <% } %>
                                            </div>
                                        <% } %>

                                    <% }) %>
                                <% } %> <!-- END CHECK BLOCKS EXIST -->
                            </div>
                        </section>
                    <% }) %>
                <% } %>
                
                <!-- Footer Lecție -->
                <div class="mt-12 pt-8 border-t border-dashed text-center" style="border-color: var(--l-border); padding-bottom: 5rem;">
                    <h3 style="font-family: serif; font-weight: 700; font-size: 1.25em; color: var(--l-text-primary);"><%= __('lesson.footer.title') %></h3>
                    <p style="font-size: 0.85em; color: var(--l-text-secondary);"><%= __('lesson.footer.subtitle') %></p>

                    <!-- CONTROALE FINALIZARE LECȚIE -->
                    <div id="lesson-controls" class="mt-6 flex justify-center gap-4 flex-wrap">
                        <% if (typeof user !== 'undefined' && user) { %>
                            <% if (typeof isCompleted !== 'undefined' && isCompleted) { %>
                                <button onclick="resetLesson()" class="px-6 py-3 rounded-full font-bold transition flex items-center gap-2 hover:scale-105" style="background: var(--l-bg-surface-hover); color: var(--l-text-secondary); border: 1px solid var(--l-border);">
                                    <i class='bx bx-refresh text-xl'></i> Resetează
                                </button>
                                <div class="px-6 py-3 rounded-full font-bold flex items-center gap-2 cursor-default" style="background: var(--l-accent-glow); color: var(--l-accent); border: 1px solid var(--l-accent);">
                                    <i class='bx bx-check-circle text-xl'></i> Completă
                                </div>
                            <% } else { %>
                                <button onclick="completeLesson()" id="btn-complete" class="px-8 py-3 rounded-full font-bold text-white transition hover:scale-105 flex items-center gap-2 shadow-lg" style="background: var(--l-accent);">
                                    <i class='bx bx-check text-xl'></i> Marchează ca Terminată
                                </button>
                            <% } %>
                        <% } else { %>
                            <a href="/auth/login" class="px-6 py-3 rounded-full font-bold transition hover:bg-white/10 text-sm" style="color: var(--l-text-secondary); border: 1px dashed var(--l-border);">
                                <i class='bx bx-log-in-circle mr-1'></i> Autentifică-te pentru a salva progresul
                            </a>
                        <% } %>
                    </div>
                </div>
            </div>
        </article>

    </div>
</div>

<!-- FLASHCARD POPOVER & LOGIC -->
<!-- Butonul plutitor care apare la selecție -->
<button id="selection-trigger-btn" class="hidden fixed z-[9999] bg-[#f59e0b] text-white p-2 rounded-lg shadow-xl hover:scale-110 transition transform animate-bounce-in" onclick="openFlashcardPopover()" style="pointer-events: auto;">
    <i class='bx bx-layer-plus text-xl'></i>
</button>

<!-- Modalul de creare Flashcard -->
<div id="flashcard-popover" class="hidden fixed z-[9999] bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl p-4 w-80 animate-fade-in backdrop-blur-md bg-opacity-95">
    <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
            <i class='bx bx-card text-[#f59e0b]'></i> Flashcard Nou
        </h3>
        <button onclick="closeFlashcardPopover()" class="text-gray-500 hover:text-white transition"><i class='bx bx-x text-lg'></i></button>
    </div>
    
    <div class="space-y-3">
        <!-- Față -->
        <div>
            <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Față (Text Selectat)</label>
            <div id="fc-front-preview" class="text-sm text-white font-medium bg-black/30 p-2.5 rounded-lg border border-gray-700 max-h-24 overflow-y-auto"></div>
        </div>
        
        <!-- Spate -->
        <div>
            <div class="flex justify-between items-center mb-1">
                <label class="block text-[10px] text-gray-500 uppercase font-bold">Spate (Traducere/Definiție)</label>
                <!-- AI Toggle -->
                <button onclick="aiTranslateSelection()" id="btn-ai-translate" class="text-[10px] bg-indigo-500/10 text-indigo-400 hover:bg-indigo-500 hover:text-white px-2 py-0.5 rounded transition flex items-center gap-1 border border-indigo-500/30">
                    <i class='bx bxs-magic-wand'></i> AI Translate
                </button>
            </div>
            <div class="relative">
                <textarea id="fc-back-input" rows="3" class="w-full bg-black/30 border border-gray-700 rounded-lg p-2.5 text-sm text-white focus:border-[#f59e0b] outline-none placeholder-gray-600 transition resize-none" placeholder="Scrie definiția sau lasă AI-ul..."></textarea>
                <div id="ai-loading" class="absolute inset-0 bg-black/50 rounded-lg flex items-center justify-center hidden backdrop-blur-sm">
                    <i class='bx bx-loader-alt bx-spin text-indigo-400 text-2xl'></i>
                </div>
            </div>
        </div>
        
        <!-- Save -->
        <button onclick="saveFlashcardFromPopover()" id="btn-save-fc" class="w-full py-2.5 bg-[#f59e0b] hover:bg-orange-600 text-white font-bold rounded-lg text-xs shadow-lg transition flex items-center justify-center gap-2">
            <i class='bx bx-save'></i> Salvează în Colecție
        </button>
    </div>
</div>

<!-- Include modalele externe -->
<%- include('../partials/modals') %>

<!-- JS Logic -->
<script>
    const isUserLoggedIn = <%= !!(typeof user !== 'undefined' && user) %>;
    
    // --- TABS & GENERAL ---
    function switchTab(tab) {
        document.getElementById('content-toc').classList.toggle('hidden', tab !== 'toc');
        document.getElementById('content-chat').classList.toggle('hidden', tab !== 'chat');
        document.getElementById('btn-tab-toc').classList.toggle('active', tab === 'toc');
        document.getElementById('btn-tab-chat').classList.toggle('active', tab === 'chat');
    }

    // --- TABLE RENDERING LOGIC ---
    function renderDynamicTables() {
        const containers = document.querySelectorAll('.js-dynamic-table');
        containers.forEach(container => {
            try {
                const rawData = container.getAttribute('data-table-content');
                let data = null;
                try { data = JSON.parse(rawData); } catch(e) { data = rawData; }

                let html = '';
                if (typeof data === 'string') {
                    html = `<div class="p-4">${data}</div>`;
                } else if (Array.isArray(data) || (typeof data === 'object' && data !== null)) {
                    html = '<table class="lesson-table">';
                    let headers = [];
                    let rows = [];

                    if (Array.isArray(data)) {
                        if (data.length > 0) {
                            headers = data[0]; 
                            rows = data.slice(1);
                        }
                    } else {
                        headers = data.headers || [];
                        rows = data.rows || [];
                    }

                    if (headers && headers.length > 0) {
                        html += '<thead><tr>';
                        headers.forEach(h => { html += `<th>${h}</th>`; });
                        html += '</tr></thead>';
                    }
                    
                    html += '<tbody>';
                    if (rows.length > 0) {
                        rows.forEach(row => {
                            html += '<tr>';
                            if (Array.isArray(row)) {
                                row.forEach(cell => { html += `<td>${cell}</td>`; });
                            } else {
                                html += `<td>${row}</td>`;
                            }
                            html += '</tr>';
                        });
                    } else {
                        html += '<tr><td colspan="100%" style="text-align:center; opacity:0.5; padding:1rem;">Fără date.</td></tr>';
                    }
                    html += '</tbody></table>';
                }
                container.innerHTML = html;
            } catch (err) {
                console.error("Eroare tabel:", err);
                container.innerHTML = '<div class="p-4 text-red-500 text-xs">Eroare afișare tabel</div>';
            }
        });
    }

    // --- SETTINGS ---
    function toggleSettings() { document.getElementById('settings-popover').classList.toggle('open'); }
    function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
    function setTheme(theme) {
        document.body.classList.remove('theme-light-mode', 'theme-sepia-mode');
        if (theme === 'light') document.body.classList.add('theme-light-mode');
        if (theme === 'sepia') document.body.classList.add('theme-sepia-mode');
    }
    function changeFont(dir) {
        const content = document.getElementById('lesson-article');
        let current = parseInt(content.style.fontSize) || 18;
        let newSize = current + dir;
        if (newSize < 12) newSize = 12;
        if (newSize > 28) newSize = 28;
        content.style.fontSize = newSize + 'px';
    }
    function toggleZen() {
        document.body.classList.toggle('zen-mode');
        if (window.innerWidth > 1024) {
            if (document.body.classList.contains('zen-mode')) {
                document.documentElement.requestFullscreen().catch(e => {});
            } else {
                if (document.fullscreenElement) document.exitFullscreen();
            }
        }
        toggleSettings(); 
    }

    // --- TIMER (RESTAURAT) ---
    let timerInt;
    let time = 1500;
    function toggleTimer() {
        const el = document.getElementById('timer-display');
        const icon = document.querySelector('#dock-timer i');
        if (timerInt) {
            clearInterval(timerInt);
            timerInt = null;
            icon.className = 'bx bx-timer text-lg';
        } else {
            icon.className = 'bx bx-pause text-lg';
            timerInt = setInterval(() => {
                time--;
                const m = Math.floor(time / 60).toString().padStart(2, '0');
                const s = (time % 60).toString().padStart(2, '0');
                el.innerText = `${m}:${s}`;
                if (time <= 0) { clearInterval(timerInt); alert("Pauză!"); time = 1500; }
            }, 1000);
        }
    }

    // --- TTS FUNCTION (RESTAURAT) ---
    function toggleTTS() {
        if ('speechSynthesis' in window) {
            if (window.speechSynthesis.speaking) {
                // If speaking, stop it
                window.speechSynthesis.cancel();
            } else {
                // Get text content from the lesson article
                const textToRead = document.getElementById('lesson-article').innerText;
                const utterance = new SpeechSynthesisUtterance(textToRead);
                
                // Optional: Set language based on current lesson language
                // Assuming currentLangCode is available or defaulting to 'ro-RO'
                utterance.lang = '<%= currentLangCode %>' === 'en' ? 'en-US' : 
                                 '<%= currentLangCode %>' === 'it' ? 'it-IT' : 'ro-RO';
                
                window.speechSynthesis.speak(utterance);
            }
        } else {
            alert("Browserul tău nu suportă funcționalitatea Text-to-Speech.");
        }
    }


    // --- FLASHCARD SYSTEM ---
    const triggerBtn = document.getElementById('selection-trigger-btn');
    const popover = document.getElementById('flashcard-popover');
    
    document.addEventListener('selectionchange', () => {
        if (!isUserLoggedIn) return; // Doar useri logați

        const selection = window.getSelection();
        if (selection.isCollapsed || !selection.toString().trim()) {
            setTimeout(() => {
                if (document.activeElement && !popover.contains(document.activeElement) && document.activeElement !== triggerBtn) {
                     triggerBtn.classList.add('hidden');
                }
            }, 100);
            return;
        }

        const lessonContent = document.getElementById('lesson-article');
        if (lessonContent && !lessonContent.contains(selection.anchorNode)) return;

        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        const top = rect.top + window.scrollY - 50;
        const left = rect.left + window.scrollX + (rect.width / 2) - 20;

        triggerBtn.style.top = `${top}px`;
        triggerBtn.style.left = `${left}px`;
        triggerBtn.classList.remove('hidden');
    });

    function openFlashcardPopover() {
        const selection = window.getSelection().toString().trim();
        if (!selection) return;

        document.getElementById('fc-front-preview').textContent = selection;
        document.getElementById('fc-back-input').value = '';
        
        const btnRect = triggerBtn.getBoundingClientRect();
        let top = btnRect.top + window.scrollY + 10;
        let left = btnRect.left + window.scrollX + 10;
        if (left + 320 > window.innerWidth) left = window.innerWidth - 340;

        popover.style.top = `${top}px`;
        popover.style.left = `${left}px`;
        popover.classList.remove('hidden');
        triggerBtn.classList.add('hidden');
    }

    function closeFlashcardPopover() {
        popover.classList.add('hidden');
    }

    async function aiTranslateSelection() {
        const text = document.getElementById('fc-front-preview').textContent;
        const loader = document.getElementById('ai-loading');
        loader.classList.remove('hidden');

        try {
            const res = await fetch('/api/ai/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sourceLang: 'auto', // Auto-detect in controller
                    targetLang: 'ro', // Fallback or current user lang pref
                    content: { text: text } 
                })
            });
            const data = await res.json();
            if (data && data.text) document.getElementById('fc-back-input').value = data.text;
        } catch(e) {
            console.error(e);
            alert('Eroare la traducerea AI.');
        } finally {
            loader.classList.add('hidden');
        }
    }

    async function saveFlashcardFromPopover() {
        const front = document.getElementById('fc-front-preview').textContent;
        const back = document.getElementById('fc-back-input').value;
        const btn = document.getElementById('btn-save-fc');

        if (!back.trim()) { alert("Te rog adaugă o traducere sau definiție."); return; }

        btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Se salvează...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/flashcards', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    front: front,
                    back: back,
                    lessonId: '<%= lesson.id %>'
                })
            });
            if (res.ok) {
                closeFlashcardPopover();
                alert("Flashcard salvat cu succes!"); 
            } else {
                const err = await res.json();
                alert('Eroare: ' + err.error);
            }
        } catch(e) { alert('Eroare de rețea.'); } finally {
            btn.innerHTML = '<i class="bx bx-save"></i> Salvează în Colecție';
            btn.disabled = false;
        }
    }

    // --- LESSON COMPLETION LOGIC ---
    async function completeLesson() {
        const btn = document.getElementById('btn-complete');
        if(btn) { btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Se salvează...'; btn.disabled = true; }
        try {
            const res = await fetch('/api/lesson/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonId: '<%= lesson.id %>' })
            });
            if (res.ok) window.location.reload();
            else { alert("Eroare la salvare."); if(btn) btn.disabled = false; }
        } catch(e) { alert("Eroare de rețea."); if(btn) btn.disabled = false; }
    }

    async function resetLesson() {
        if(!confirm("Sigur vrei să resetezi progresul?")) return;
        try {
            const res = await fetch('/api/lesson/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonId: '<%= lesson.id %>' })
            });
            if (res.ok) window.location.reload();
        } catch(e) { console.error(e); }
    }

    // --- CHAT LOGIC ---
    const chatContainer = document.querySelector('#tab-content-chat .space-y-4');
    const chatInputBtn = document.querySelector('#chat-input-area button');
    const chatInputField = document.querySelector('#chat-input-area input');
    const currentLessonId = "<%= lesson.id %>"; 

    async function sendMessage() {
        const content = chatInputField.value;
        if (!content.trim()) return;
        chatInputBtn.disabled = true;
        try {
            const response = await fetch('/api/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonId: currentLessonId, content: content })
            });
            const result = await response.json();
            if (response.ok) {
                appendMessageToUI(result.message.username, result.message.content, 'acum', true); 
                chatInputField.value = ''; 
            }
        } catch (e) { console.error(e); } finally { chatInputBtn.disabled = false; }
    }

    function appendMessageToUI(user, text, time, isMe) {
        const html = `
            <div class="group px-2 animate-fade-in">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full ${isMe ? 'bg-orange-600' : 'bg-blue-600'} text-white text-[9px] flex items-center justify-center font-bold">${user.charAt(0).toUpperCase()}</div>
                        <span class="text-xs font-bold ${isMe ? 'text-[var(--l-accent)]' : 'text-[var(--l-text-primary)]'}">${user}</span>
                    </div>
                    <span class="text-[9px] text-[var(--l-text-secondary)]">${time}</span>
                </div>
                <p class="text-xs text-[var(--l-text-secondary)] pl-7 leading-relaxed">${text}</p>
            </div>
        `;
        let messagesContainer = document.querySelector('#content-chat .pl-2')?.parentElement || document.getElementById('content-chat');
        const inputArea = document.getElementById('chat-input-area');
        const msgDiv = document.createElement('div');
        msgDiv.innerHTML = html;
        if (inputArea && messagesContainer.contains(inputArea)) messagesContainer.insertBefore(msgDiv, inputArea);
        else messagesContainer.appendChild(msgDiv);
        msgDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    if(chatInputBtn) chatInputBtn.addEventListener('click', sendMessage);
    if(chatInputField) chatInputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    async function loadMessages() {
        try {
            const res = await fetch(`/api/chat/${currentLessonId}`);
            const data = await res.json();
            if(data.messages && Array.isArray(data.messages)) {
                const messagesArea = document.getElementById('content-chat');
                const pinnedHeader = messagesArea.querySelector('.rounded-r-lg'); 
                const inputArea = document.getElementById('chat-input-area');
                Array.from(messagesArea.children).forEach(child => { if (child !== pinnedHeader && child !== inputArea) child.remove(); });
                data.messages.forEach(msg => {
                    appendMessageToUI(msg.username, msg.content, new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), false);
                });
            }
        } catch(e) { console.error("Eroare chat:", e); }
    }
    
    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        loadMessages();
        renderDynamicTables();
    });
    
</script>

<!-- Note Modal -->
<div id="modal-notes" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center backdrop-blur-sm">
    <div class="p-6 rounded-2xl w-96 shadow-2xl" style="background: var(--l-bg-surface); border: 1px solid var(--l-border);">
        <h3 class="font-bold mb-4" style="color: var(--l-text-primary);">Notițe</h3>
        <textarea class="w-full rounded-lg p-3 outline-none h-40" style="background: var(--l-bg-body); color: var(--l-text-primary); border: 1px solid var(--l-border);"></textarea>
        <div class="flex justify-end mt-4 gap-2">
            <button onclick="toggleModal('modal-notes')" class="px-4 py-2 rounded transition hover:bg-white/10" style="color: var(--l-text-secondary);">Închide</button>
            <button class="px-4 py-2 rounded font-bold text-white transition hover:opacity-90" style="background: var(--l-accent);">Salvează</button>
        </div>
    </div>
</div>